name: Laundry Buddy Backend CI-CD

on: 
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:


  # -------------------------------
  # 1) (TESTING)
  # -------------------------------
  test:
    name: Run Test (CI)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: Backend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm 
          cache-dependency-path: Backend/package-lock.json
      
      - name: Install Dependencies
        run: npm ci

      - name: Run test cases
        run: npm test --if-present


  # -------------------------------
  # 2) LINT JOB
  # -------------------------------
  lint:
    needs: test
    name: Lint Code (CI)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: Backend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: Backend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint


  # -------------------------------
  # 3) SECURITY JOB
  # -------------------------------
  security:
    name: Security Check (npm audit)
    runs-on: ubuntu-latest
    needs: [test,lint]

    defaults:
      run:
        working-directory: Backend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: Backend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high


  # -------------------------------
  # 4) BUILD DOCKER IMAGE AND PUSH ON DOCKER HUB
  # -------------------------------


  build_and_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint, security]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Image
        uses: docker/build-push-action@v6
        with:
          context: ./Backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/laundrybuddy-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/laundrybuddy-backend:${{ github.sha }}

  # -------------------------------
  # 5) DEPLOY ON EC2 
  # -------------------------------


  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy via SSH (Pull & Run latest image)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd ~/laundrybuddy/Backend
          docker-compose pull
          docker-compose up -d
          docker image prune -af

    - name: Wait for app to start
      run: sleep 15

    - name: Health Check
      run: |
        curl -f http://${{ secrets.SSH_HOST }}:3000/health

